/*
 * mymain.c
 */

#include "main.h"
#include "CommTask.h"
#include "Led.h"
#include "cli.h"
#include <string.h>
#include <stdio.h>


extern TIM_HandleTypeDef htim6;


//Led ledB;
//HandlerFunc handlOn;
//HandlerFunc handlOff;
/*extern I2C_HandleTypeDef hi2c1;
extern TIM_HandleTypeDef htim3;
extern TIM_HandleTypeDef htim6;

Led ledB;
Led ledR;
Buzzer buzzer;
Rtc rtc;
*/
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
	/*ledOnTimerInterrupt(&ledB);
	ledOnTimerInterrupt(&ledR);

	buzzerOnTimerInterrupt(&buzzer);

	accessOnTimerInterrupt();*/
}


static void handleCommand()
{
	char cmd[20];
	char code[10];

	char * command = commLastCommand();

	int params = sscanf(command, "%s %s", cmd, code);

	if (params == 0)
	{
		return;
	}
	if (strcmp(cmd, "ledon") == 0){
		//ledOn(&ledB);
		ledB.ledon(&ledB);
		//ledB.pledon(&ledB);
		//staticLedOn;
		//handlOn(&ledB);
		//_on(&ledB);


	}
	else if(strcmp(cmd, "ledoff") == 0)
	{
		//ledOff(&ledB);
		//staticLedOff;
		ledB.ledoff(&ledB);
		//handlOff(&ledB);
	}
	else if (strcmp(cmd, "setcode") == 0 && params > 1)
	{
		//accessSetCode(code);
	}
	else if (strcmp(cmd, "code") == 0 && params > 1)
	{
		//accessCheckCode(code);
	}
	else if (strcmp(cmd, "time") == 0)
	{
		/*DateTime dateTime;
		rtcGetTime(&rtc, &dateTime);
		printf("%02d:%02d:%02d-%d-%02d/%02d/%02d\r\n",
				dateTime.hours, dateTime.min, dateTime.sec,
				dateTime.weekDay,
				dateTime.day, dateTime.month, dateTime.year);
				*/
	}
	else
	{
		printf("Invalid command\r\n");
		return;
	}
}


void myMain()
{
	//HAL_NVIC_EnableIRQ(TIM6_DAC_IRQn);
	//HAL_TIM_Base_Start_IT(&htim6);

	//ledInit(&ledB, LBLUE_GPIO_Port, LBLUE_Pin);
	/*handlOn = ledOn;
	handlOff = ledOff;
	handlOn(&ledB);
	handlOff(&ledB);*/
	//RegisterCallbacks(handlOn,handlOff,&ledB);

	//staticLedOn;
	//staticLedOff;


	/*ledInit(&ledB, LBLUE_GPIO_Port, LBLUE_Pin);
	ledInit(&ledR, LRED_GPIO_Port, LRED_Pin);

	buzzerInit(&buzzer, &htim3);

	rtcInit(&rtc, &hi2c1, 0xD0);

	accessInit();
*/
	ledInit(&ledR, LRED_GPIO_Port, LRED_Pin);
	cliInit();
	while (1) {
		if (commTask()) {
			handleCommand();
		}

	}
}

