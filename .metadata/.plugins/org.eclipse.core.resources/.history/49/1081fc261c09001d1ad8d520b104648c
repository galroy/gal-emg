#include "Dht11.h"
#include "main.h"
#include <stdio.h>

extern TIM_HandleTypeDef htim16;
//extern Dht11 TempHum;

uint8_t DhtBuffer[5] = {0};



static void Dht11_setOutput(Dht11 * dht)
{
	GPIO_InitTypeDef GPIO_InitStruct;

	GPIO_InitStruct.Pin = dht->gpioPin;
	GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
	GPIO_InitStruct.Pull = GPIO_NOPULL;
	GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
	HAL_GPIO_Init(dht->gpioPort, &GPIO_InitStruct);
}

static void Dht11_setInput(Dht11 * dht)
{
	GPIO_InitTypeDef GPIO_InitStruct;

	GPIO_InitStruct.Pin = dht->gpioPin;
	GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
	GPIO_InitStruct.Pull = GPIO_NOPULL;
	GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
	HAL_GPIO_Init(dht->gpioPort, &GPIO_InitStruct);
}

static void Dht11_reciveData_Async(Dht11 *dht) {
	for (int i = 0; i < 5; i++) {
		for (int j = 0; j < 8; j++) {
			__HAL_TIM_SET_COUNTER(&htim16, 0);
			while (HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 0) {
				if (__HAL_TIM_GET_COUNTER(&htim16) > 80) {
					return;
				}
			}
			__HAL_TIM_SET_COUNTER(&htim16, 0);
			while (HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 1) {
				if (__HAL_TIM_GET_COUNTER(&htim16) > 100) {
					return;
				}
			}
			DhtBuffer[i] <<= 1;
			if (__HAL_TIM_GET_COUNTER(&htim16) > 50) {
				DhtBuffer[i] |= 1;
			}
		}
	}
	int checkSum = DhtBuffer[0] + DhtBuffer[1] + DhtBuffer[2] + DhtBuffer[3];
	if (checkSum == DhtBuffer[4]) {
		dht->humidity = DhtBuffer[0] + (DhtBuffer[1] * 0.1);
		dht->temperature = DhtBuffer[2] + (DhtBuffer[3] * 0.1);
		dht->checkSum = checkSum;

		printf("Humidity - %u.%u\r\nTemperature - %u.%u\r\nChekSum - %u\r\n",
				DhtBuffer[0],DhtBuffer[1],DhtBuffer[2],DhtBuffer[3],DhtBuffer[4]);
		dht->state = DHT11_STATE_DATA_RECEIVED;
		//Dht11_printTempHum(dht);
	}
}
static void Dht11_reciveData(Dht11 * dht)
{
	for(int i = 0; i < 5; i++){
		for(int j = 0; j < 8; j++){
			__HAL_TIM_SET_COUNTER(&htim16, 0);
			while(HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 0){
				if(__HAL_TIM_GET_COUNTER(&htim16) > 80){
					return;
				}
			}
			__HAL_TIM_SET_COUNTER(&htim16, 0);
			while(HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 1){
				if(__HAL_TIM_GET_COUNTER(&htim16) > 100){
					return;
				}
			}
			DhtBuffer[i] <<= 1;
			if(__HAL_TIM_GET_COUNTER(&htim16) > 50){
				DhtBuffer[i] |= 1;
			}
		}
	}
	int checkSum = DhtBuffer[0] + DhtBuffer[1] + DhtBuffer[2] + DhtBuffer[3];
	if(checkSum == DhtBuffer[4]){
		dht->humidity = DhtBuffer[0] + (DhtBuffer[1]*0.1);
		dht->temperature = DhtBuffer[2] + (DhtBuffer[3]*0.1);
		dht->checkSum = checkSum;

		//printf("Humidity - %u.%u\r\nTemperature - %u.%u\r\nChekSum - %u\r\n",DhtBuffer[0],DhtBuffer[1],DhtBuffer[2],DhtBuffer[3],DhtBuffer[4]);
		//Dht11_printTempHum(dht);
	}
}

static void setGpioExti(Dht11 *dht) {
	GPIO_InitTypeDef gpioStruct = { 0 };
	gpioStruct.Pin = dht->gpioPin;
	gpioStruct.Mode = GPIO_MODE_IT_FALLING;
	gpioStruct.Pull = GPIO_PULLUP;
	HAL_GPIO_Init(dht->gpioPort, &gpioStruct);
	HAL_NVIC_EnableIRQ(EXTI9_5_IRQn);

}


void Dht11_init(Dht11 * dht)
{
//we in GPIO_Input or output

	dht->gpioPin = DHT_Pin;
	dht->gpioPort = DHT_GPIO_Port;
	dht->state = DHT11_STATE_SLEEP;
	dht->humidity = 0.0;
	dht->temperature = 0.0;
	dht->checkSum = 0;
	setGpioExti(dht);
}

void Dht11_Start(Dht11 * dht)
{
	Dht11_setOutput(dht);
	HAL_GPIO_WritePin(dht->gpioPort, dht->gpioPin, 0);
	__HAL_TIM_SET_COUNTER(&htim16, 0);
	//MCU lowering the signal for 18ms
	while(__HAL_TIM_GET_COUNTER(&htim16) < 18500) {
	}

	HAL_GPIO_WritePin(dht->gpioPort, dht->gpioPin, 1);
	Dht11_setInput(dht);
	__HAL_TIM_SET_COUNTER(&htim16, 0);
	//MCU raising the signal for 40us
	while(HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 1){
		if(__HAL_TIM_GET_COUNTER(&htim16) > 60){
			return;
		}
	}
	//DHT11 lowering the signal for 80us
	__HAL_TIM_SET_COUNTER(&htim16, 0);
	while(HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 0){
		if(__HAL_TIM_GET_COUNTER(&htim16) > 90){
			return;
		}
	}
	//DHT11 raising the signal for 80us
	__HAL_TIM_SET_COUNTER(&htim16, 0);
	while(HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 1){
		if(__HAL_TIM_GET_COUNTER(&htim16) > 90){
			return;
		}
	}
	Dht11_reciveData(dht);
}


static void Dht11_Init_Dht11(Dht11 *dht) {

	Dht11_setOutput(dht);
	HAL_GPIO_WritePin(dht->gpioPort, dht->gpioPin, 0);
	__HAL_TIM_SET_COUNTER(&htim16, 0);
	//MCU lowering the signal for 18ms
	while (__HAL_TIM_GET_COUNTER(&htim16) < 18000) {
	}
	dht->state = DHT11_STATE_INIT;
}
static void Dht11_Wakink(Dht11 *dht) {
	HAL_GPIO_WritePin(dht->gpioPort, dht->gpioPin, 1);
	Dht11_setInput(dht);
	__HAL_TIM_SET_COUNTER(&htim16, 0);
	//MCU raising the signal for 40us
	while (HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 1) {
		if (__HAL_TIM_GET_COUNTER(&htim16) > 60) {
			dht->state = DHT11_STATE_ERR;
		}
	}
	dht->state = DHT11_STATE_WAKING;
}

static void Dht11_Awating_Respone_Start(Dht11 *dht) {
	//DHT11 lowering the signal for 80us
	//__HAL_TIM_SET_COUNTER(&htim16, 0);
	while (HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 0) {
		/*if (__HAL_TIM_GET_COUNTER(&htim16) > 90) {
			dht->state = DHT11_STATE_ERR;
		}*/
	}

	//DHT11 raising the signal for 80us
	//__HAL_TIM_SET_COUNTER(&htim16, 0);
	while (HAL_GPIO_ReadPin(dht->gpioPort, dht->gpioPin) == 1) {
		/*if (__HAL_TIM_GET_COUNTER(&htim16) > 90) {
			dht->state = DHT11_STATE_ERR;
		}*/
	}
	dht->state = DHT11_STATE_RECEIVING_BITS;
}

void Dht11_Start_Async(Dht11 *dht)
{
	switch((int)dht->state)
	{
	case DHT11_STATE_SLEEP:
		Dht11_Init_Dht11(dht);
		break;
	case DHT11_STATE_INIT:
		Dht11_Wakink(dht);
		break;
	case DHT11_STATE_WAKING:
		Dht11_Awating_Respone_Start(dht);
		break;
	case DHT11_STATE_RECEIVING_BITS:
		Dht11_reciveData_Async(dht);
		break;
	case DHT11_STATE_DATA_RECEIVED:
		dht->state = DHT11_STATE_SUCCESS;
		break;
	}

}

void Dht11_onGpioInterrupt(Dht11 *dht, uint16_t pin) {
	if (pin == dht->gpioPin) {
		switch ((int) dht->state) {
		case DHT11_STATE_SLEEP:
			Dht11_Init_Dht11(dht);
			break;
		case DHT11_STATE_INIT:
			Dht11_Wakink(dht);
			break;
		case DHT11_STATE_WAKING:
			Dht11_Awating_Respone_Start(dht);
			break;
		case DHT11_STATE_RECEIVING_BITS:
			Dht11_reciveData_Async(dht);
			break;
		case DHT11_STATE_DATA_RECEIVED:
			dht->state = DHT11_STATE_SUCCESS;
			break;
		};
	}

}




